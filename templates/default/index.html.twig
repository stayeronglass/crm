{% extends 'base.html.twig' %}

{% block title %}Hello DefaultController!{% endblock %}

{% block body %}
    <br />
    <br />
{% for i in m %}
    <a class="btn btn-primary" href="{{ path('app_booking', {'id' : i.id}) }}">{{ i.title }}</a>
{% endfor %}

        <div id="ec"></div>

        <dialog id="dialog" >
            <div class="row" >
            <form id="form" method="dialog">
                <h2>Make Reservation</h2>
                <h3 id="room-name"></h3>
                <h3 id="date"></h3>
                <div class="row">
                    <label for="start">Start:</label>
                    <input type="time" id="start" name="start-time">
                </div>
                <div class="row">
                    <label for="end">End:</label>
                    <input type="time" id="end" name="end-time">
                </div>
                <div class="row">
                    <label for="comment">Comment:</label>
                    <textarea id="comment" name="comment"></textarea>
                </div>
                <menu>
                    <button id="cancel" type="reset">Cancel</button>
                    <button id="confirm" type="submit">Confirm</button>
                </menu>
            </form>
            </div>
        </dialog>



        <script type="text/javascript">
            const events = [{
                id: 1,
                resourceIds: [1],
                start: createDate(9, 0),
                end: createDate(10, 30),
                title: 'Editable Event',
                editable: true,
            }, {
                id: 2,
                resourceIds: [2],
                start: createDate(11, 0),
                end: createDate(13, 30),
                title: 'Uneditable Event',
                // editable: false, // not work
                startEditable: false,
                durationEditable: false,
                backgroundColor: 'red',
            }];

            const resources = {{ resources|json_encode()|raw }}

            function createDate(hours, minutes) {
                const now = new Date();
                now.setHours(hours);
                now.setMinutes(minutes);
                now.setSeconds(0);
                return now;
            }
            function showModal(event) {
                function getResourceTitle(event) {
                    const resourceId = event.resource ? event.resource.id : event.resourceIds[0];
                    const resource = resources.find(r => r.id == resourceId);
                    return resource ? resource.title : '';
                }
                document.getElementById('room-name').innerText = getResourceTitle(event);
                const startDate = dayjs(event.start);
                document.getElementById('date').innerText = startDate.format('YYYY/MM/DD');
                document.getElementById('start').value = startDate.format('HH:mm');
                document.getElementById('end').value = dayjs(event.end).format('HH:mm');
                document.getElementById('comment').value = event.title || '';
                dialog.event = event;
                dialog.showModal();
            }
            function hasOverlappingEvents(event) {
                return getOverlappingEvents(event).length > 0;
            }
            function hasOtherOverlappingEvents(event) {
                return getOverlappingEvents(event).filter(e => e.id != event.id).length > 0
            }
            function getOverlappingEvents(event) {
                // select event has event.resource.id
                // eventDrop event has event.resourceIds
                const rId = event.resource ? event.resource.id : event.resourceIds[0];
                return ec.getEvents().filter(e => e.resourceIds[0] == rId && e.start < event.end && event.start < e.end);
            }

            const ec = EventCalendar.create(document.getElementById('ec'), {
                view: 'resourceTimeGridDay',
                headerToolbar: {
                    start: 'prev,next today',
                    center: 'title',
                    end: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek resourceTimeGridWeek,resourceTimelineWeek'
                },
                resources: resources,
                scrollTime: '09:00:00',
                eventSources: [{
                    url: '{{ path('app_ajax_events') }}',
                    method: 'POST',
                    extraParams: function () {
                        return {
                            action: 'bookly_get_staff_appointments',
                            csrf_token: BooklyL10nGlobal.csrf_token,
                            staff_ids: obj.options.getStaffMemberIds(),
                            location_ids: obj.options.getLocationIds(),
                            service_ids: obj.options.getServiceIds()
                        };
                    }
                }],
                dayMaxEvents: true,
                nowIndicator: true,
                selectable: true,
                select: function(event) {
                    if (hasOverlappingEvents(event)) {
                        ec.unselect();
                        return;
                    }
                    showModal(event);
                },
            });


            async  function getResources() {
                let result = null;
                $.ajax({
                    url: "{{ path('app_ajax_resources') }}",
                    method: "GET",
                    async: false, // This makes the call synchronous
                    success: function(data) {
                        result = data;
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX Error:", error);
                    }
                });
                console.log(result)
                return result; // This will now return the data after the synchronous call completes
            }

            function _pad(num) {
                let norm = Math.floor(Math.abs(num));
                return (norm < 10 ? '0' : '') + norm;
            }
        </script>


    {% endblock %}

    {% block javascripts %}
        <script src="https://cdn.jsdelivr.net/npm/@event-calendar/build@4.7.1/dist/event-calendar.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
    {% endblock %}

    {% block stylesheets %}
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@event-calendar/build@4.7.1/dist/event-calendar.min.css">

        <style>
            .ec-timeline .ec-time, .ec-timeline .ec-line {
                width: 16px;
            }
            .ec-timeline .ec-time {
                overflow: visible;
            }
            .ec-timeline .ec-time time {
                display: inline-block;
                width: 64px;
                text-align: center;
            }
        </style>
    {% endblock %}



