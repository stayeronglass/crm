{% extends 'base.html.twig' %}

{% block title %}Hello DefaultController!{% endblock %}

{% block body %}
    <div class="alert  alert-dismissible fade" role="alert" id="ajaxMessage" style="display: none;">
        <span id="messageContent">111</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <br />
    <br />
{% for i in m %}
    <a class="btn btn-primary" href="{{ path('app_booking', {'id' : i.id}) }}">{{ i.title }}</a>
{% endfor %}

        <div id="ec"></div>

        <dialog id="dialog" >
            <h1>Новая Запись</h1>
            {{ form(form, {'attr': {'id': 'form_event'}}) }}
        </dialog>



        <script type="text/javascript">
            const events = [{
                id: 1,
                resourceIds: [1],
                start: createDate(9, 0),
                end: createDate(10, 30),
                title: 'Editable Event',
                editable: true,
            }, {
                id: 2,
                resourceIds: [2],
                start: createDate(11, 0),
                end: createDate(13, 30),
                title: 'Uneditable Event',
                // editable: false, // not work
                startEditable: false,
                durationEditable: false,
                backgroundColor: 'red',
            }];

            const resources = {{ resources|json_encode()|raw }}

            function createDate(hours, minutes) {
                const now = new Date();
                now.setHours(hours);
                now.setMinutes(minutes);
                now.setSeconds(0);
                return now;
            }
            function showModal(event) {
                function getResourceTitle(event) {
                    const resourceId = event.resource ? event.resource.id : event.resourceIds[0];
                    const resource = resources.find(r => r.id == resourceId);
                    return resource ? resource.title : '';
                }
                // document.getElementById('room-name').innerText = getResourceTitle(event);
                // const startDate = dayjs(event.start);
                // document.getElementById('date').innerText = startDate.format('YYYY/MM/DD');
                // document.getElementById('start').value = startDate.format('HH:mm');
                // document.getElementById('end').value = dayjs(event.end).format('HH:mm');
                // document.getElementById('comment').value = event.title || '';
                dialog.event = event;
                dialog.showModal();
            }
            function hasOverlappingEvents(event) {
                return getOverlappingEvents(event).length > 0;
            }
            function hasOtherOverlappingEvents(event) {
                return getOverlappingEvents(event).filter(e => e.id != event.id).length > 0
            }
            function getOverlappingEvents(event) {
                // select event has event.resource.id
                // eventDrop event has event.resourceIds
                const rId = event.resource ? event.resource.id : event.resourceIds[0];
                return ec.getEvents().filter(e => e.resourceIds[0] == rId && e.start < event.end && event.start < e.end);
            }

            const ec = EventCalendar.create(document.getElementById('ec'), {
                view: 'resourceTimeGridDay',
                headerToolbar: {
                    start: 'prev,next today',
                    center: 'title',
                    end: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek resourceTimeGridWeek,resourceTimelineWeek'
                },
                resources: resources,
                scrollTime: '09:00:00',
                eventSources: [{
                    url: '{{ path('app_ajax_events') }}',
                    method: 'POST',
                    extraParams: function () {
                        return {

                        };
                    }
                }],
                dayMaxEvents: true,
                nowIndicator: true,
                selectable: true,
                select: function(event) {
                    if (hasOverlappingEvents(event)) {
                        ec.unselect();
                        return;
                    }
                    showModal(event);
                },
            });


            async  function getResources() {
                let result = null;
                $.ajax({
                    url: "{{ path('app_ajax_resources') }}",
                    method: "GET",
                    async: false, // This makes the call synchronous
                    success: function(data) {
                        result = data;
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX Error:", error);
                    }
                });
                console.log(result)
                return result; // This will now return the data after the synchronous call completes
            }

            function _pad(num) {
                let norm = Math.floor(Math.abs(num));
                return (norm < 10 ? '0' : '') + norm;
            }


            document.addEventListener('DOMContentLoaded', function() {
                const form = document.querySelector('[name="event"]');

                if (form) {
                    form.addEventListener('submit', function(event) {
                        event.preventDefault(); // Prevent default form submission

                        const formData = new FormData(form); // Or serialize to JSON

                        fetch(form.action, {
                            method: form.method,
                            body: formData, // Or JSON.stringify(Object.fromEntries(formData))
                            headers: {
                                'Accept': 'application/json' // Expecting JSON response
                            }
                        })
                            .then(response => response.json()) // Parse JSON response
                            .then(data => {
                                if (data.success) {
                                    data.flashMessages.forEach(function(flash) {
                                        // Create and append a div for the flash message
                                        $('#ajaxMessage').removeClass('alert-danger').addClass('alert-success');
                                        $('#messageContent').text(flash); // Assuming 'message' in response
                                        $('#ajaxMessage').fadeIn(); // Show the alert
                                    });
                                } else {
                                    // Handle errors, e.g., display validation errors
                                    console.error('Form submission failed:', data);
                                }
                                dialog.close();
                            })
                            .catch(error => {
                                console.error('Network error or server issue:', error);
                            });
                    });
                }
            });
        </script>


    {% endblock %}

    {% block javascripts %}
        <script src="https://cdn.jsdelivr.net/npm/@event-calendar/build@4.7.1/dist/event-calendar.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
    {% endblock %}

    {% block stylesheets %}
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@event-calendar/build@4.7.1/dist/event-calendar.min.css">

        <style>
            .ec-timeline .ec-time, .ec-timeline .ec-line {
                width: 16px;
            }
            .ec-timeline .ec-time {
                overflow: visible;
            }
            .ec-timeline .ec-time time {
                display: inline-block;
                width: 64px;
                text-align: center;
            }
        </style>
    {% endblock %}



